<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MACI MUSIC App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <style>
        /* CSS Variables for consistent sizing */
        :root {
            --header-height: 88px; /* Based on logo height + padding */
            --bottom-nav-height: 56px; /* Based on icon/text height + padding */
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f8f9fa; /* Fondo blanco como solicitado */
            color: #202124; /* Color de texto oscuro para contraste */
            overflow-x: hidden; /* Evita el desplazamiento horizontal en el cuerpo */
            touch-action: pan-y; /* Mejora la respuesta táctil para el desplazamiento vertical */
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        /* Asegura que el encabezado y la barra de navegación inferior no se encojan y tengan alturas consistentemente */
        header {
            flex-shrink: 0;
            height: var(--header-height); /* Establece la altura basada en la variable */
        }

        .bottom-nav {
            flex-shrink: 0;
            height: var(--bottom-nav-height); /* Establece la altura basada en la variable */
        }

        /* El área de contenido principal debe ocupar el espacio vertical restante */
        main {
            flex-grow: 1; /* Permite que el contenido principal ocupe todo el espacio vertical disponible */
            position: relative;
            overflow: hidden; /* Oculta las secciones desbordantes durante el deslizamiento horizontal */
            height: calc(100vh - var(--header-height) - var(--bottom-nav-height));
            margin-top: 0; /* Asegura que no haya margen superior adicional */
        }

        /* Contenedor para las secciones horizontales (anuncios, metrónomo, IA) */
        .section-container {
            display: flex;
            flex-wrap: nowrap; /* Mantiene las secciones en una sola fila para el deslizamiento horizontal */
            height: 100%; /* Ocupa el 100% de la altura del padre (main) */
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform; /* Optimiza para transiciones suaves */
        }

        /* Cada sección individual (página) */
        #content-pages > section {
            flex-shrink: 0; /* Evita que las secciones se encojan */
            width: 100vw; /* Cada sección ocupa el ancho completo del viewport */
            height: 100%; /* Cada sección ocupa la altura completa de su padre (section-container) */
            overflow-y: auto; /* Habilita el desplazamiento vertical para el contenido dentro de cada sección */
            box-sizing: border-box; /* Incluye el padding en el ancho y alto total del elemento */
            padding: 24px; /* Padding predeterminado para las secciones */
            display: flex; /* Convierte las secciones en contenedores flex para el diseño interno */
            flex-direction: column; /* El contenido dentro de las secciones fluye verticalmente */
            justify-content: center; /* Centra el contenido verticalmente si no está lleno */
            align-items: center; /* Centra el contenido horizontalmente si no está lleno */
        }

        /* Estilos específicos del metrónomo */
        .metronome-beat {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .metronome-beat.active {
            transform: scale(1.15);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }
        
        /* Estilos del modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #f0f0f0; /* Color gris claro para las ventanas del modal */
            padding: 24px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            position: relative;
        }
        
        .close-button {
            position: absolute;
            top: 12px;
            right: 12px;
            font-size: 24px;
            cursor: pointer;
            color: #5f6368;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .close-button:hover {
            background-color: rgba(0,0,0,0.04);
        }
        
        .admin-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #dadce0;
        }
        
        .admin-list-item:last-child {
            border-bottom: none;
        }
        
        .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid #1a73e8;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Selector de color para el metrónomo */
        .color-picker-container {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .color-picker {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        /* Google-style buttons */
        .btn-primary {
            background-color: #1a73e8;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .btn-primary:hover {
            background-color: #1765cc;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-secondary {
            background-color: #ffffff;
            color: #1a73e8;
            border: 1px solid #dadce0;
            padding: 10px 24px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-secondary:hover {
            background-color: #f8f9fa;
            border-color: #d2e3fc;
        }
        
        .btn-danger {
            background-color: #ea4335;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .btn-danger:hover {
            background-color: #d33b27;
        }
        
        /* Animación para el metrónomo */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .pulse-animation {
            animation: pulse 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Inputs estilo Google */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #dadce0;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a73e8;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a73e8;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        select, textarea, input[type="text"], input[type="password"] {
            font-family: 'Roboto', sans-serif;
            font-size: 16px;
            padding: 12px 16px;
            border: 1px solid #dadce0;
            border-radius: 4px;
            outline: none;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        
        select:focus, textarea:focus, input[type="text"]:focus, input[type="password"]:focus {
            border-color: #1a73e8;
        }
        
        /* Tarjetas estilo Google */
        .google-card {
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 2px 6px 2px rgba(60,64,67,0.15);
            padding: 24px;
            margin-bottom: 24px;
            width: 100%; /* Asegura que la tarjeta ocupe todo el ancho de su contenedor */
            max-width: 600px; /* Ancho máximo para pantallas más grandes */
        }
        /* Tamaño específico de la tarjeta para la sección del metrónomo */
        #section-metronome .google-card {
            max-width: 500px; /* La tarjeta del metrónomo puede ser ligeramente más estrecha */
        }
        
        /* Ajustes responsivos para móviles (hasta 768px) */
        @media (max-width: 768px) {
            :root {
                --header-height: 70px; /* Ajusta la altura del encabezado para móviles */
                --bottom-nav-height: 60px; /* Ajusta la altura de la barra de navegación inferior para móviles */
            }
            header {
                padding: 16px;
            }
            header img {
                height: 48px;
            }
            /* La altura principal se ajusta automáticamente por las variables */
            
            #content-pages > section {
                padding: 16px; /* Ajusta el padding para las secciones móviles */
            }
            
            #section-metronome .google-card {
                padding: 16px;
            }
            
            .metronome-visual-container h1 {
                font-size: 24px;
                margin-bottom: 16px;
                font-weight: 400;
            }
            
            /* Tamaño del metrónomo reducido para móviles */
            #metronomeVisual {
                width: 96px; /* w-24 */
                height: 96px; /* h-24 */
            }
            
            #metronomeVisual i {
                font-size: 40px; /* text-5xl */
            }
            
            #bpmDisplay {
                font-size: 48px;
                font-weight: 300;
            }
            
            button {
                padding: 12px 24px;
                font-size: 14px;
                min-height: 48px;
            }
            
            .modal-content {
                width: 95%;
                padding: 16px;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            #section-ai-assistant h2 {
                font-size: 24px;
                margin-bottom: 16px;
                font-weight: 400;
            }
            
            #music-theory-response {
                min-height: 150px;
            }
        }
        
        /* Para tablets */
        @media (min-width: 769px) and (max-width: 1024px) {
            #content-pages > section {
                padding: 24px;
            }
        }
        
        /* Para desktop */
        @media (min-width: 1025px) {
            #content-pages > section {
                padding: 32px;
            }
            /* Tamaño del metrónomo para escritorio */
            #metronomeVisual {
                width: 128px; /* w-32 */
                height: 128px; /* h-32 */
            }
            
            #metronomeVisual i {
                font-size: 64px; /* text-6xl */
            }
        }
        
        /* Mejoras táctiles */
        .touch-friendly {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
        
        /* Configuración de Material Icons */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
        }
        
        /* Navegación inferior estilo Google */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            z-index: 100;
        }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            border-radius: 50px;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        
        .nav-item.active {
            background-color: #e8f0fe;
            color: #1a73e8;
        }
        
        .nav-item .material-icons {
            font-size: 24px;
            margin-bottom: 4px;
        }
        
        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }
        
        /* Estilo del metrónomo en pantalla completa */
        .fullscreen-metronome {
            display: none; /* Ocultar completamente el metrónomo en pantalla completa */
        }
        
        /* Barra de búsqueda estilo Google (si se implementa en el futuro) */
        .search-bar {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            border: 1px solid #dadce0;
            border-radius: 24px;
            padding: 8px 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }
        
        .search-bar .material-icons {
            color: #5f6368;
            margin-right: 8px;
        }
        
        .search-bar input {
            border: none;
            outline: none;
            flex: 1;
            font-size: 16px;
            background: transparent;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col touch-friendly">
    <!-- Header y Logo -->
    <header class="bg-white text-gray-900 shadow-sm relative flex items-center justify-center">
        <img src="https://uploads.onecompiler.io/43hc5xg2u/43h4ev88f/LIGO%20MACI.png" alt="MACI MUSIC Logo" class="h-16 w-auto" onerror="this.onerror=null;this.src='https://placehold.co/200x70/ffffff/000000?text=MACI+MUSIC+LOGO';">
        <div id="admin-icon" class="absolute top-3 right-3 cursor-pointer text-gray-600 hover:text-gray-800 transition-colors duration-200 p-2 rounded-full hover:bg-gray-100">
            <span class="material-icons">settings</span>
        </div>
    </header>
    
    <!-- Contenido Principal -->
    <main id="main-content-area" class="flex-grow relative overflow-hidden">
        <div id="content-pages" class="flex flex-nowrap section-container">
            <!-- Announcement Area -->
            <section id="section-announcements" class="flex-shrink-0 flex flex-col page-transition">
                <div class="google-card flex-grow flex flex-col">
                    <h2 class="text-2xl font-light mb-6 text-gray-800">Anuncios y Videos</h2>
                    
                    <div id="announcement-area" class="flex-grow bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-700 text-base leading-relaxed overflow-auto">
                        <div id="announcement-text-display">
                            <!-- Default message or loaded announcements -->
                        </div>
                        <div id="announcement-video-display" class="mt-4 grid grid-cols-1 gap-4">
                            <!-- YouTube videos will be embedded here -->
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Sección del Metrónomo -->
            <section id="section-metronome" class="flex-shrink-0 flex flex-col items-center justify-center page-transition">
                <div class="google-card w-full max-w-md flex-grow flex flex-col justify-center">
                    <div class="metronome-visual-container">
                        <!-- Botón de pantalla completa eliminado -->
                        
                        <h1 class="text-3xl font-light text-center text-gray-800 mb-8">
                            <span class="material-icons align-middle mr-2">music_note</span>Metrónomo
                        </h1>
                        
                        <!-- Visual Metrónomo -->
                        <div class="flex justify-center mb-8">
                            <div id="metronomeVisual" class="w-48 h-48 bg-gray-100 rounded-full flex items-center justify-center metronome-beat">
                                <span class="material-icons text-6xl text-gray-800">music_note</span>
                            </div>
                        </div>
                        
                        <!-- Display BPM y Compás -->
                        <div class="text-center mb-8">
                            <div class="text-6xl font-thin mb-2 text-gray-800">
                                <span id="bpmDisplay">120</span> <span class="text-2xl">BPM</span>
                            </div>
                            <div class="text-xl text-gray-600">
                                Compás: <span id="beatCount" class="font-medium">4</span>/4
                            </div>
                        </div>
                        
                        <!-- Controles -->
                        <div class="space-y-6 w-full">
                            <!-- Control BPM -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Tempo (BPM)
                                </label>
                                <input type="range" id="bpmSlider" min="40" max="200" value="120">
                                <div class="flex justify-between text-xs text-gray-500 mt-1">
                                    <span>40</span>
                                    <span>200</span>
                                </div>
                            </div>
                            
                            <!-- Contenedor para Compás y Sonido (ahora en línea) -->
                            <div class="flex flex-row gap-4">
                                <!-- Compás -->
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Compás
                                    </label>
                                    <select id="timeSignature">
                                        <option value="2/4">2/4</option>
                                        <option value="3/4">3/4</option>
                                        <option value="4/4" selected>4/4</option>
                                        <option value="6/8">6/8</option>
                                    </select>
                                </div>
                                
                                <!-- Selector de Sonido del Metrónomo -->
                                <div class="w-1/2">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                        Sonido
                                    </label>
                                    <select id="metronomeSoundSelect">
                                        <option value="standard">Estándar (Click)</option>
                                        <option value="woodblock">Bloque de Madera</option>
                                        <option value="bell">Campana</option>
                                        <option value="tick">Tick</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Volumen del Metrónomo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Volumen
                                </label>
                                <input type="range" id="volume-input" min="0" max="100" value="75">
                            </div>
                            
                            <!-- Selector de Color del Metrónomo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Color del Metrónomo
                                </label>
                                <div class="color-picker-container">
                                    <input type="color" id="metronome-color" class="color-picker" value="#dadce0">
                                    <span class="text-sm text-gray-600">Haz clic para cambiar el color</span>
                                </div>
                            </div>
                            
                            <!-- Botones de Control -->
                            <div class="flex gap-4">
                                <button id="playPauseBtn" class="flex-1 btn-primary">
                                    <span class="material-icons align-middle mr-2">play_arrow</span>
                                    <span id="playPauseText">Reproducir</span>
                                </button>
                                
                                <button id="tapTempoBtn" class="flex-1 btn-secondary">
                                    <span class="material-icons align-middle mr-2">touch_app</span>
                                    Tap
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- New Section: Music Theory AI Assistant -->
            <section id="section-ai-assistant" class="flex-shrink-0 flex flex-col page-transition">
                <div class="google-card flex-grow flex flex-col">
                    <h2 class="text-2xl font-light mb-6 text-gray-800">
                        <span class="material-icons align-middle mr-2">psychology</span>Asistente de Teoría Musical
                    </h2>
                    
                    <div class="mb-4 flex-grow">
                        <label for="music-theory-question-input" class="block text-gray-700 text-sm font-medium mb-2">Haz una pregunta de teoría musical:</label>
                        <textarea id="music-theory-question-input" rows="3" placeholder="Ej: ¿Qué es el contrapunto?"></textarea>
                    </div>
                    
                    <button id="ask-music-theory-btn" class="btn-primary mb-4">
                        Obtener Respuesta
                        <span class="material-icons align-middle ml-1 text-sm">auto_awesome</span>
                        <span id="music-theory-spinner" class="loading-spinner hidden"></span>
                    </button>
                    
                    <div id="music-theory-response" class="mt-4 bg-gray-50 p-4 rounded-lg border border-gray-200 text-gray-700 text-base leading-relaxed overflow-auto flex-grow">
                        <!-- AI response will appear here -->
                        <p class="text-gray-500 italic">Tu respuesta aparecerá aquí.</p>
                    </div>
                </div>
            </section>
        </div>
        
        <!-- Page Indicators (Eliminados) -->
        <!-- Navigation Arrows for mobile (Eliminados) -->
    </main>
    
    <!-- Bottom Navigation for Mobile -->
    <nav class="bottom-nav">
        <div class="nav-item active" data-index="0">
            <span class="material-icons">campaign</span>
            <span>Anuncios</span>
        </div>
        <div class="nav-item" data-index="1">
            <span class="material-icons">music_note</span>
            <span>Metrónomo</span>
        </div>
        <div class="nav-item" data-index="2">
            <span class="material-icons">psychology</span>
            <span>Asistente</span>
        </div>
    </nav>
    
    <!-- Password Modal for Admin Access -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-password-modal">
                <span class="material-icons">close</span>
            </span>
            <h3 class="text-xl font-medium mb-6 text-gray-800">Acceso de Administración</h3>
            <div class="mb-6">
                <label for="admin-password-input" class="block text-gray-700 text-sm font-medium mb-2">Contraseña:</label>
                <input type="password" id="admin-password-input" placeholder="Introduce la contraseña">
            </div>
            <button id="submit-password" class="btn-primary">Acceder</button>
            <div id="password-message" class="mt-4 text-red-500 font-medium"></div>
        </div>
    </div>
    
    <!-- Main Admin Modal -->
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-admin-modal">
                <span class="material-icons">close</span>
            </span>
            <h3 class="text-xl font-medium mb-6 text-gray-800">Panel de Administración</h3>
            
            <!-- Section for Text Announcements -->
            <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-lg font-medium mb-4 text-gray-700">Anuncios de Texto</h4>
                <div class="mb-4">
                    <label for="new-announcement-text" class="block text-gray-700 text-sm font-medium mb-2">Contenido del Anuncio:</label>
                    <textarea id="new-announcement-text" rows="4" placeholder="Escribe aquí tu nuevo anuncio..."></textarea>
                </div>
                <div class="mb-4">
                    <button id="generate-announcement-ai-btn" class="btn-secondary">
                        Generar Anuncio con IA
                        <span class="material-icons align-middle ml-1 text-sm">auto_awesome</span>
                        <span id="announcement-ai-spinner" class="loading-spinner hidden"></span>
                    </button>
                </div>
                <button id="add-announcement" class="btn-primary mb-4">Agregar Anuncio</button>
                
                <h5 class="text-base font-medium mb-3 text-gray-700">Anuncios Actuales:</h5>
                <div id="admin-text-announcements-list" class="space-y-2 text-gray-800 text-sm">
                    <!-- Announcements will be listed here dynamically -->
                </div>
                <p id="no-text-announcements" class="text-gray-500 mt-2 text-center" style="display: none;">No hay anuncios de texto.</p>
            </div>
            
            <!-- Section for YouTube Videos -->
            <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                <h4 class="text-lg font-medium mb-4 text-gray-700">Videos de YouTube</h4>
                <div class="mb-4">
                    <label for="youtube-link-input" class="block text-gray-700 text-sm font-medium mb-2">Nuevo Enlace de YouTube:</label>
                    <input type="text" id="youtube-link-input" placeholder="Ej: https://www.youtube.com/watch?v=VIDEO_ID">
                </div>
                <button id="add-video" class="btn-primary mb-4">Agregar Video</button>
                
                <h5 class="text-base font-medium mb-3 text-gray-700">Videos Actuales:</h5>
                <div id="admin-videos-list" class="space-y-2 text-gray-800 text-sm">
                    <!-- Videos will be listed here dynamically -->
                </div>
                <p id="no-videos" class="text-gray-500 mt-2 text-center" style="display: none;">No hay videos publicados.</p>
            </div>
            
            <!-- Area for confirmation/error messages -->
            <div id="admin-message" class="mt-4 text-center text-green-600 font-medium"></div>
        </div>
    </div>
    
    <!-- Fullscreen Metronome Container (Eliminado) -->
    <!-- Este div ha sido completamente eliminado del HTML ya que la funcionalidad de pantalla completa se ha quitado. -->

    <!-- Generic Confirmation Modal -->
    <div id="confirmation-modal" class="modal">
        <div class="modal-content">
            <h3 id="confirmation-title" class="text-xl font-medium mb-4 text-gray-800">Confirmar Acción</h3>
            <p id="confirmation-message" class="mb-6 text-gray-700">¿Estás seguro de que quieres realizar esta acción?</p>
            <div class="flex justify-end gap-3">
                <button id="confirm-no-btn" class="btn-secondary">Cancelar</button>
                <button id="confirm-yes-btn" class="btn-primary btn-danger">Confirmar</button>
            </div>
        </div>
    </div>
    
    <script>
        // Variables globales para el metrónomo
        let audioContext = null;
        let metronomeInterval = null;
        let isMetronomePlaying = false;
        let currentBeat = 0;
        let tapTimes = [];
        let tapTimeout = null;
        
        // Variables para los elementos del DOM
        let elements = {};
        
        // Define different metronome sound presets
        const metronomeSoundPresets = {
            standard: { type: 'sine', accentFreq: 1000, normalFreq: 800, duration: 0.15, decay: 0.05 },
            woodblock: { type: 'square', accentFreq: 1200, normalFreq: 1000, duration: 0.1, decay: 0.01 },
            bell: { type: 'triangle', accentFreq: 900, normalFreq: 700, duration: 0.2, decay: 0.08 },
            tick: { type: 'sawtooth', accentFreq: 1500, normalFreq: 1300, duration: 0.08, decay: 0.005 }
        };
        
        // Constants
        const LS_ANNOUNCEMENTS_KEY = 'maciMusicAnnouncements';
        const LS_VIDEOS_KEY = 'maciMusicVideos';
        const CORRECT_PASSWORD = '9999';
        const SECTIONS = ['section-announcements', 'section-metronome', 'section-ai-assistant'];
        
        // Variables for navigation
        let currentSectionIndex = 0;
        let startX = 0;
        let currentX = 0;
        let startY = 0; // Added for vertical scroll detection
        let currentY = 0; // Added for vertical scroll detection
        let isDragging = false;
        let isMouseDown = false;
        let isTouchDown = false;
        let isInteractingWithControl = false; // New flag for slider/select interaction
        const dragThreshold = 30; // Reduced for mobile
        const startDragThreshold = 20; // Reduced for mobile
        const scrollThreshold = 10; // Threshold to determine if it's a vertical scroll
        
        // Variables for local storage
        let storedAnnouncements = [];
        let storedVideos = [];
        
        // Dynamic check for mobile
        let isMobile = window.innerWidth <= 768;
        
        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            storeDOMElements(); // Store references to DOM elements
            setupEventListeners(); // Set up all event listeners
            loadContentFromLocalStorage(); // Load content from local storage
            updateSectionDisplay(); // Display the initial section
            
            // Handle window resizing to update mobile status
            window.addEventListener('resize', () => {
                isMobile = window.innerWidth <= 768; // Update isMobile flag
            });
        });
        
        // Function to store references to DOM elements for efficient access
        function storeDOMElements() {
            // Metronome elements
            elements.bpmSlider = document.getElementById('bpmSlider');
            elements.bpmDisplay = document.getElementById('bpmDisplay');
            elements.timeSignatureSelect = document.getElementById('timeSignature');
            elements.beatCountDisplay = document.getElementById('beatCount');
            elements.metronomeVisual = document.getElementById('metronomeVisual');
            elements.playPauseBtn = document.getElementById('playPauseBtn');
            elements.playPauseText = document.getElementById('playPauseText');
            elements.tapTempoBtn = document.getElementById('tapTempoBtn');
            elements.volumeInput = document.getElementById('volume-input');
            elements.metronomeSoundSelect = document.getElementById('metronomeSoundSelect');
            elements.metronomeColor = document.getElementById('metronome-color');
            
            // Admin elements
            elements.adminIcon = document.getElementById('admin-icon');
            elements.passwordModal = document.getElementById('password-modal');
            elements.closePasswordModalBtn = document.getElementById('close-password-modal');
            elements.adminPasswordInput = document.getElementById('admin-password-input');
            elements.submitPasswordBtn = document.getElementById('submit-password');
            elements.passwordMessage = document.getElementById('password-message');
            elements.adminModal = document.getElementById('admin-modal');
            elements.closeAdminModalBtn = document.getElementById('close-admin-modal');
            
            // Announcement elements
            elements.addAnnouncementBtn = document.getElementById('add-announcement');
            elements.newAnnouncementText = document.getElementById('new-announcement-text');
            elements.announcementTextDisplay = document.getElementById('announcement-text-display');
            elements.adminTextAnnouncementsList = document.getElementById('admin-text-announcements-list');
            elements.noTextAnnouncementsMsg = document.getElementById('no-text-announcements');
            elements.generateAnnouncementAIButton = document.getElementById('generate-announcement-ai-btn');
            elements.announcementAISpinner = document.getElementById('announcement-ai-spinner');
            
            // Video elements
            elements.youtubeLinkInput = document.getElementById('youtube-link-input');
            elements.addVideoBtn = document.getElementById('add-video');
            elements.announcementVideoDisplay = document.getElementById('announcement-video-display');
            elements.adminVideosList = document.getElementById('admin-videos-list');
            elements.noVideosMsg = document.getElementById('no-videos');
            elements.adminMessage = document.getElementById('admin-message');
            
            // AI Assistant elements
            elements.musicTheoryQuestionInput = document.getElementById('music-theory-question-input');
            elements.askMusicTheoryBtn = document.getElementById('ask-music-theory-btn');
            elements.musicTheoryResponseDiv = document.getElementById('music-theory-response');
            elements.musicTheorySpinner = document.getElementById('music-theory-spinner');
            
            // Navigation elements
            elements.contentPages = document.getElementById('content-pages');
            elements.mainContentArea = document.getElementById('main-content-area');
            elements.navItems = document.querySelectorAll('.nav-item');

            // Confirmation modal elements
            elements.confirmationModal = document.getElementById('confirmation-modal');
            elements.confirmationTitle = document.getElementById('confirmation-title');
            elements.confirmationMessage = document.getElementById('confirmation-message');
            elements.confirmNoBtn = document.getElementById('confirm-no-btn');
            elements.confirmYesBtn = document.getElementById('confirm-yes-btn');
        }
        
        // Function to set up all event listeners
        function setupEventListeners() {
            // Metronome event listeners
            elements.bpmSlider.addEventListener('input', () => updateBPM(elements.bpmSlider.value));
            elements.timeSignatureSelect.addEventListener('change', () => updateTimeSignature(elements.timeSignatureSelect.value));
            elements.playPauseBtn.addEventListener('click', toggleMetronome);
            elements.tapTempoBtn.addEventListener('click', tapTempo);
            elements.volumeInput.addEventListener('input', updateVolume);
            elements.metronomeSoundSelect.addEventListener('change', updateSound);
            elements.metronomeColor.addEventListener('input', updateMetronomeColor);
            
            // Admin event listeners
            elements.adminIcon.addEventListener('click', showPasswordModal);
            elements.closePasswordModalBtn.addEventListener('click', hidePasswordModal);
            elements.adminPasswordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });
            elements.submitPasswordBtn.addEventListener('click', checkPassword);
            elements.closeAdminModalBtn.addEventListener('click', hideAdminModal);
            
            // Announcement event listeners
            elements.addAnnouncementBtn.addEventListener('click', addAnnouncement);
            elements.generateAnnouncementAIButton.addEventListener('click', generateAnnouncementWithAI);
            
            // Video event listeners
            elements.addVideoBtn.addEventListener('click', addVideo);
            
            // AI Assistant event listeners
            elements.musicTheoryQuestionInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Allow Shift+Enter for new line
                    e.preventDefault();
                    askMusicTheory();
                }
            });
            elements.askMusicTheoryBtn.addEventListener('click', askMusicTheory);
            
            // Bottom navigation items
            elements.navItems.forEach(item => {
                item.addEventListener('click', (event) => {
                    const index = parseInt(event.currentTarget.dataset.index);
                    navigateToPage(index);
                });
            });
            
            // Drag events for section swiping
            setupDragEvents();
            
            // Keyboard event for metronome tap and navigation
            document.addEventListener('keydown', handleKeyDown);
            
            // Close modals when clicking outside
            window.addEventListener('click', handleWindowClick);

            // Confirmation modal buttons
            elements.confirmNoBtn.addEventListener('click', () => hideConfirmationModal(false));
            elements.confirmYesBtn.addEventListener('click', () => hideConfirmationModal(true));
        }
        
        // --- Metronome Functions ---
        function initializeAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }
        
        function updateBPM(value) {
            elements.bpmDisplay.textContent = value;
            elements.bpmSlider.value = value;
            
            if (isMetronomePlaying) {
                stopMetronome();
                startMetronome();
            }
        }
        
        function updateTimeSignature(value) {
            const beats = value.split('/')[0];
            elements.beatCountDisplay.textContent = beats;
            elements.timeSignatureSelect.value = value;
            
            currentBeat = 0; // Reset beat count on time signature change
        }
        
        function updateVolume() {
            // Volume is read directly from the input element in playMetronomeBeat
            // No need for explicit update logic here
        }
        
        function updateSound() {
            // Sound is read directly from the select element in playMetronomeBeat
            // If metronome is playing, stop and restart to apply new sound
            if (isMetronomePlaying) {
                stopMetronome();
                startMetronome();
            }
        }
        
        function updateMetronomeColor() {
            const color = elements.metronomeColor.value;
            elements.metronomeVisual.style.backgroundColor = color;
            
            // Update icon color based on background brightness for readability
            const icon = elements.metronomeVisual.querySelector('.material-icons');
            
            const r = parseInt(color.substr(1, 2), 16);
            const g = parseInt(color.substr(3, 2), 16);
            const b = parseInt(color.substr(5, 2), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            
            if (brightness > 128) { /* Light background, use dark icon */
                icon.style.color = '#202124';
            } else { /* Dark background, use light icon */
                icon.style.color = '#ffffff';
            }
        }
        
        function toggleMetronome() {
            if (isMetronomePlaying) {
                stopMetronome();
            } else {
                startMetronome();
            }
        }
        
        function startMetronome() {
            initializeAudio();
            
            const bpm = parseInt(elements.bpmSlider.value);
            const interval = 60000 / bpm; // Interval in milliseconds
            
            isMetronomePlaying = true;
            
            // Update play/pause button
            const playIcon = '<span class="material-icons align-middle mr-2">play_arrow</span>';
            const pauseIcon = '<span class="material-icons align-middle mr-2">pause</span>';

            elements.playPauseBtn.innerHTML = `${pauseIcon}<span id="playPauseText">Pausar</span>`;
            elements.playPauseBtn.classList.remove('btn-primary');
            elements.playPauseBtn.classList.add('btn-danger');
            
            metronomeInterval = setInterval(() => {
                playMetronomeBeat();
                animateMetronome();
            }, interval);
        }
        
        function stopMetronome() {
            isMetronomePlaying = false;
            
            // Update play/pause button
            const playIcon = '<span class="material-icons align-middle mr-2">play_arrow</span>';
            const pauseIcon = '<span class="material-icons align-middle mr-2">pause</span>';

            elements.playPauseBtn.innerHTML = `${playIcon}<span id="playPauseText">Reproducir</span>`;
            elements.playPauseBtn.classList.remove('btn-danger');
            elements.playPauseBtn.classList.add('btn-primary');
            
            if (metronomeInterval) {
                clearInterval(metronomeInterval);
                metronomeInterval = null;
            }
            
            // Reset animation state
            elements.metronomeVisual.classList.remove('active', 'pulse-animation');
        }
        
        function playMetronomeBeat() {
            const timeSignature = elements.timeSignatureSelect.value;
            const beats = parseInt(timeSignature.split('/')[0]);
            
            currentBeat = (currentBeat + 1) % beats;
            
            // Get the selected sound preset
            const selectedSound = elements.metronomeSoundSelect.value;
            const soundParams = metronomeSoundPresets[selectedSound];
            
            // Create oscillator and gain node
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Connect nodes
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Set oscillator type and frequency based on selected sound and beat accent
            oscillator.type = soundParams.type;
            oscillator.frequency.value = currentBeat === 0 ? soundParams.accentFreq : soundParams.normalFreq;
            
            // Configure sound envelope with volume control
            const volume = elements.volumeInput ? (elements.volumeInput.value / 100) : 0.75;
            gainNode.gain.setValueAtTime(0.6 * volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(soundParams.decay * volume, audioContext.currentTime + soundParams.duration);
            
            // Play and stop sound
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + soundParams.duration);
        }
        
        function animateMetronome() {
            elements.metronomeVisual.classList.add('active', 'pulse-animation');
            
            // Remove animation classes after a short delay to allow re-triggering
            setTimeout(() => {
                elements.metronomeVisual.classList.remove('active', 'pulse-animation');
            }, 100);
        }
        
        function tapTempo() {
            const now = Date.now();
            tapTimes.push(now);
            
            // Keep only the last 4 taps
            if (tapTimes.length > 4) {
                tapTimes.shift();
            }
            
            if (tapTimes.length >= 2) {
                // Calculate average BPM from tap intervals
                const intervals = [];
                for (let i = 1; i < tapTimes.length; i++) {
                    intervals.push(tapTimes[i] - tapTimes[i - 1]);
                }
                
                const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
                const bpm = Math.round(60000 / avgInterval);
                
                // Clamp BPM between 40 and 200
                const clampedBPM = Math.min(Math.max(bpm, 40), 200);
                
                // Update slider and display
                elements.bpmSlider.value = clampedBPM;
                updateBPM(clampedBPM); // This will also restart metronome if playing
            }
            
            // Reset tap times after 2 seconds without new taps
            clearTimeout(tapTimeout);
            tapTimeout = setTimeout(() => {
                tapTimes = [];
            }, 2000);
        }
        
        // --- Admin Functions ---
        function showPasswordModal() {
            elements.adminPasswordInput.value = ''; // Clear password input
            elements.passwordMessage.textContent = ''; // Clear message
            elements.passwordModal.style.display = 'flex';
            elements.adminPasswordInput.focus(); // Focus on input field
        }
        
        function hidePasswordModal() {
            elements.passwordModal.style.display = 'none';
        }
        
        function checkPassword() {
            if (elements.adminPasswordInput.value === CORRECT_PASSWORD) {
                elements.passwordMessage.textContent = '';
                elements.passwordModal.style.display = 'none';
                renderAdminPanelLists(); // Render content in admin panel
                elements.adminModal.style.display = 'flex'; // Show admin modal
                elements.adminMessage.textContent = ''; // Clear admin message area
            } else {
                elements.passwordMessage.textContent = 'Contraseña incorrecta. Inténtalo de nuevo.';
                elements.passwordMessage.style.color = '#EA4335'; // Red color for error
            }
        }
        
        function hideAdminModal() {
            elements.adminModal.style.display = 'none';
        }
        
        // --- Local Storage and Rendering Functions ---
        function loadContentFromLocalStorage() {
            try {
                const savedAnnouncements = localStorage.getItem(LS_ANNOUNCEMENTS_KEY);
                if (savedAnnouncements) {
                    storedAnnouncements = JSON.parse(savedAnnouncements);
                } else {
                    // Default announcements if none are saved
                    storedAnnouncements = [{
                        id: Date.now(),
                        text: '¡Bienvenido a MACI MUSIC! Aquí encontrarás las últimas novedades y eventos.'
                    }, {
                        id: Date.now() + 1,
                        text: '¡Prepara tus instrumentos, la música nunca para!'
                    }];
                }
                
                const savedVideos = localStorage.getItem(LS_VIDEOS_KEY);
                if (savedVideos) {
                    storedVideos = JSON.parse(savedVideos);
                } else {
                    storedVideos = []; // Default empty
                }
            } catch (e) {
                console.error("Error loading from localStorage, resetting data:", e);
                // Fallback to default in case of corrupted storage
                storedAnnouncements = [{
                    id: Date.now(),
                    text: '¡Bienvenido a MACI MUSIC! Aquí encontrarás las últimas novedades y eventos.'
                }, {
                    id: Date.now() + 1,
                    text: '¡Prepara tus instrumentos, la música nunca para!'
                }];
                storedVideos = [];
            }
            
            renderContent(); // Render content to the UI after loading
        }
        
        function saveContentToLocalStorage() {
            localStorage.setItem(LS_ANNOUNCEMENTS_KEY, JSON.stringify(storedAnnouncements));
            localStorage.setItem(LS_VIDEOS_KEY, JSON.stringify(storedVideos));
        }
        
        function renderContent() {
            renderAnnouncementsDisplay();
            renderVideosDisplay();
            renderAdminPanelLists();
        }
        
        function renderAnnouncementsDisplay() {
            elements.announcementTextDisplay.innerHTML = ''; // Clear previous content
            
            if (storedAnnouncements.length === 0) {
                elements.announcementTextDisplay.innerHTML = '<p class="text-gray-500 italic">No hay anuncios publicados.</p>';
            } else {
                storedAnnouncements.forEach(ann => {
                    const p = document.createElement('p');
                    p.classList.add('mt-2');
                    p.innerHTML = ann.text.replace(/\n/g, '<br>'); // Preserve newlines
                    elements.announcementTextDisplay.appendChild(p);
                });
            }
        }
        
        function renderVideosDisplay() {
            elements.announcementVideoDisplay.innerHTML = ''; // Clear previous content
            
            if (storedVideos.length > 0) {
                storedVideos.forEach(vidId => {
                    const videoWrapper = document.createElement('div');
                    videoWrapper.classList.add('aspect-video', 'w-full', 'rounded-lg', 'overflow-hidden', 'shadow-md');
                    videoWrapper.innerHTML = `
                        <iframe
                            class="w-full h-full"
                            src="https://www.youtube.com/embed/${vidId}"
                            frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    `;
                    elements.announcementVideoDisplay.appendChild(videoWrapper);
                });
            }
            // No message needed if no videos, as it's optional content
        }
        
        function renderAdminPanelLists() {
            // Render Text Announcements in Admin Panel
            elements.adminTextAnnouncementsList.innerHTML = '';
            
            if (storedAnnouncements.length === 0) {
                elements.noTextAnnouncementsMsg.style.display = 'block';
            } else {
                elements.noTextAnnouncementsMsg.style.display = 'none';
                
                storedAnnouncements.forEach((ann, index) => {
                    const item = document.createElement('div');
                    item.classList.add('admin-list-item');
                    item.innerHTML = `
                        <span class="truncate pr-2">${ann.text.substring(0, 50)}${ann.text.length > 50 ? '...' : ''}</span>
                        <button data-index="${index}" class="btn-danger text-xs delete-announcement-btn">Eliminar</button>
                    `;
                    elements.adminTextAnnouncementsList.appendChild(item);
                });
                
                // Attach event listeners to new delete buttons
                document.querySelectorAll('.delete-announcement-btn').forEach(button => {
                    button.onclick = (e) => deleteAnnouncement(parseInt(e.target.dataset.index));
                });
            }
            
            // Render YouTube Videos in Admin Panel
            elements.adminVideosList.innerHTML = '';
            
            if (storedVideos.length === 0) {
                elements.noVideosMsg.style.display = 'block';
            } else {
                elements.noVideosMsg.style.display = 'none';
                
                storedVideos.forEach((vidId, index) => {
                    const item = document.createElement('div');
                    item.classList.add('admin-list-item');
                    item.innerHTML = `
                        <span class="truncate pr-2">Video ID: ${vidId}</span>
                        <button data-index="${index}" class="btn-danger text-xs delete-video-btn">Eliminar</button>
                    `;
                    elements.adminVideosList.appendChild(item);
                });
                
                // Attach event listeners to new delete buttons
                document.querySelectorAll('.delete-video-btn').forEach(button => {
                    button.onclick = (e) => deleteVideo(parseInt(e.target.dataset.index));
                });
            }
        }
        
        function showAdminMessage(message, isError = false) {
            elements.adminMessage.textContent = message;
            elements.adminMessage.style.color = isError ? '#EA4335' : '#34A853';
        }
        
        function addAnnouncement() {
            const newContent = elements.newAnnouncementText.value.trim();
            
            if (newContent !== '') {
                storedAnnouncements.push({ id: Date.now(), text: newContent });
                saveContentToLocalStorage();
                renderContent();
                elements.newAnnouncementText.value = '';
                showAdminMessage('¡Anuncio de texto agregado con éxito!');
            } else {
                showAdminMessage('El anuncio de texto no puede estar vacío.', true);
            }
        }
        
        function deleteAnnouncement(index) {
            showConfirmationModal('¿Estás seguro de que quieres eliminar este anuncio?', 'Eliminar Anuncio', (confirmed) => {
                if (confirmed) {
                    storedAnnouncements.splice(index, 1);
                    saveContentToLocalStorage();
                    renderContent();
                    showAdminMessage('¡Anuncio de texto eliminado con éxito!');
                }
            });
        }
        
        function addVideo() {
            const youtubeLink = elements.youtubeLinkInput.value.trim();
            const videoId = getYouTubeVideoId(youtubeLink);
            
            if (videoId) {
                // Check if video already exists to prevent duplicates
                if (!storedVideos.includes(videoId)) {
                    storedVideos.push(videoId);
                    saveContentToLocalStorage();
                    renderContent();
                    elements.youtubeLinkInput.value = '';
                    showAdminMessage('¡Video agregado con éxito!');
                } else {
                    showAdminMessage('Este video ya está publicado.', true);
                }
            } else {
                showAdminMessage('Enlace de YouTube no válido. Asegúrate de que sea un enlace de video de YouTube válido.', true);
            }
        }
        
        function deleteVideo(index) {
            showConfirmationModal('¿Estás seguro de que quieres eliminar este video?', 'Eliminar Video', (confirmed) => {
                if (confirmed) {
                    storedVideos.splice(index, 1);
                    saveContentToLocalStorage();
                    renderContent();
                    showAdminMessage('¡Video eliminado con éxito!');
                }
            });
        }
        
        function getYouTubeVideoId(url) {
            let videoId = null;
            const regex = /(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regex);
            
            if (match && match[1]) {
                videoId = match[1];
            }
            
            return videoId;
        }

        // --- Confirmation Modal Functions ---
        let confirmationCallback = null; // Stores the callback to execute after confirmation

        function showConfirmationModal(message, title = 'Confirmar Acción', callback) {
            elements.confirmationTitle.textContent = title;
            elements.confirmationMessage.textContent = message;
            confirmationCallback = callback; // Store the provided callback function
            elements.confirmationModal.style.display = 'flex'; // Show the modal
        }

        function hideConfirmationModal(result) {
            elements.confirmationModal.style.display = 'none'; // Hide the modal
            if (confirmationCallback) {
                confirmationCallback(result); // Execute the stored callback with the result (true/false)
                confirmationCallback = null; // Reset the callback
            }
        }
        
        // --- AI Functions ---
        async function generateAnnouncementWithAI() {
            const userPrompt = elements.newAnnouncementText.value.trim();
            const prompt = `Genera **únicamente** un anuncio **muy breve** y atractivo para una aplicación de música llamada MACI MUSIC. Si se proporciona una idea: "${userPrompt}", utilízala. Si no, crea un anuncio general sobre novedades o eventos musicales. El tono debe ser entusiasta y amigable, y el anuncio debe ser directo y sin introducciones conversacionales.`;
            
            elements.newAnnouncementText.value = 'Generando anuncio con IA...'; // Provide immediate feedback
            const generatedText = await callGeminiAPI(prompt, elements.announcementAISpinner, elements.generateAnnouncementAIButton);
            
            if (generatedText) {
                elements.newAnnouncementText.value = generatedText;
                showAdminMessage('¡Anuncio generado por IA! Puedes editarlo y agregarlo.');
            } else {
                elements.newAnnouncementText.value = userPrompt; // Restore original prompt on error
                showAdminMessage('Error al generar el anuncio con IA.', true);
            }
        }
        
        async function askMusicTheory() {
            const question = elements.musicTheoryQuestionInput.value.trim();
            
            if (question === '') {
                elements.musicTheoryResponseDiv.innerHTML = '<p class="text-red-500">Por favor, escribe tu pregunta.</p>';
                return;
            }
            
            elements.musicTheoryResponseDiv.innerHTML = '<p class="text-gray-500 italic">Obteniendo respuesta de la IA...</p>'; // Loading state
            const prompt = `Responde a la siguiente pregunta sobre teoría musical de forma concisa y clara. Si la pregunta no es directamente sobre teoría musical, indica que no puedes responderla. Pregunta: "${question}"`;
            
            const responseText = await callGeminiAPI(prompt, elements.musicTheorySpinner, elements.askMusicTheoryBtn);
            
            if (responseText) {
                elements.musicTheoryResponseDiv.innerHTML = responseText.replace(/\n/g, '<br>'); // Display response, preserve newlines
            } else {
                elements.musicTheoryResponseDiv.innerHTML = '<p class="text-red-500">Error al obtener la respuesta. Inténtalo de nuevo.</p>';
            }
        }
        
        // Helper function for making Gemini API calls with exponential backoff
        async function fetchWithExponentialBackoff(url, options, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        // Retry for rate limits (429) or server errors (5xx)
                        if (response.status === 429 || response.status >= 500) {
                            // console.warn(`Retry attempt ${i + 1} for ${url}. Status: ${response.status}`); // For debugging
                            await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                            continue; // Retry
                        }
                    }
                    return response; // Return on success or non-retriable error
                }
                catch (error) {
                    // console.warn(`Fetch error on attempt ${i + 1} for ${url}: ${error}`); // For debugging
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                    } else {
                        throw error; // Re-throw error after last retry attempt
                    }
                }
            }
            throw new Error('Max retries exceeded for API call');
        }

        async function callGeminiAPI(prompt, spinnerElement, buttonElement) {
            spinnerElement.classList.remove('hidden'); // Show spinner
            if (buttonElement) buttonElement.disabled = true; // Disable button
            
            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            
            // Usar la clave API proporcionada por el usuario. Si se ejecuta en Canvas, esta puede ser sobrescrita.
            const apiKey = "AIzaSyCdJlDVHGrtEffmB2cNHd7IlHtYlR7vVN4"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            try {
                const response = await fetchWithExponentialBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error('Unexpected API response structure:', result);
                    return 'Error: No se pudo obtener una respuesta de la IA.';
                }
            } catch (error) {
                console.error('Error calling Gemini API:', error);
                return 'Error: No se pudo conectar con la IA. Inténtalo de nuevo más tarde.';
            } finally {
                spinnerElement.classList.add('hidden'); // Hide spinner
                if (buttonElement) buttonElement.disabled = false; // Re-enable button
            }
        }
        
        // --- Navigation Functions ---
        function updateSectionDisplay() {
            const offset = currentSectionIndex * -100; // Calculate offset for horizontal translation
            elements.contentPages.style.transform = `translateX(${offset}%)`;
            updateBottomNav(); // Update active state of bottom navigation items
        }
        
        function updateBottomNav() {
            elements.navItems.forEach((item, index) => {
                if (index === currentSectionIndex) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function navigateToPage(index) {
            if (index >= 0 && index < SECTIONS.length && index !== currentSectionIndex) {
                currentSectionIndex = index;
                updateSectionDisplay();
            }
        }
        
        function navigateSections(direction) {
            let newIndex = currentSectionIndex + direction;
            
            if (newIndex < 0) {
                newIndex = 0; // Prevent going below first page
            } else if (newIndex >= SECTIONS.length) {
                newIndex = SECTIONS.length - 1; // Prevent going beyond last page
            }
            
            if (newIndex !== currentSectionIndex) {
                currentSectionIndex = newIndex;
                updateSectionDisplay();
            }
        }
        
        // --- Drag/Swipe Functions for Navigation ---
        function setupDragEvents() {
            elements.mainContentArea.addEventListener('mousedown', handleMouseDown);
            elements.mainContentArea.addEventListener('mousemove', handleMouseMove);
            elements.mainContentArea.addEventListener('mouseup', handleMouseUp);
            elements.mainContentArea.addEventListener('mouseleave', handleMouseLeave);
            
            elements.mainContentArea.addEventListener('touchstart', handleTouchStart);
            elements.mainContentArea.addEventListener('touchmove', handleTouchMove);
            elements.mainContentArea.addEventListener('touchend', handleTouchEnd);

            // Event listeners to detect interaction with controls and disable swipe
            elements.bpmSlider.addEventListener('touchstart', () => isInteractingWithControl = true);
            elements.bpmSlider.addEventListener('touchend', () => isInteractingWithControl = false);
            elements.volumeInput.addEventListener('touchstart', () => isInteractingWithControl = true);
            elements.volumeInput.addEventListener('touchend', () => isInteractingWithControl = false);
            elements.timeSignatureSelect.addEventListener('touchstart', (e) => { isInteractingWithControl = true; e.stopPropagation(); }); // Stop propagation for select
            elements.timeSignatureSelect.addEventListener('touchend', () => isInteractingWithControl = false);
            elements.metronomeSoundSelect.addEventListener('touchstart', (e) => { isInteractingWithControl = true; e.stopPropagation(); }); // Stop propagation for select
            elements.metronomeSoundSelect.addEventListener('touchend', () => isInteractingWithControl = false);

            // For desktop, use mousedown/mouseup for controls
            elements.bpmSlider.addEventListener('mousedown', () => isInteractingWithControl = true);
            elements.bpmSlider.addEventListener('mouseup', () => isInteractingWithControl = false);
            elements.volumeInput.addEventListener('mousedown', () => isInteractingWithControl = true);
            elements.volumeInput.addEventListener('mouseup', () => isInteractingWithControl = false);
            elements.timeSignatureSelect.addEventListener('mousedown', (e) => { isInteractingWithControl = true; e.stopPropagation(); }); // Stop propagation for select
            elements.timeSignatureSelect.addEventListener('mouseup', () => isInteractingWithControl = false);
            elements.metronomeSoundSelect.addEventListener('mousedown', (e) => { isInteractingWithControl = true; e.stopPropagation(); }); // Stop propagation for select
            elements.metronomeSoundSelect.addEventListener('mouseup', () => isInteractingWithControl = false);
        }
        
        function handleMouseDown(e) {
            if (isInteractingWithControl) return; // Prevent drag if interacting with controls
            if (!isMobile) return; // Only allow drag on mobile
            
            isMouseDown = true;
            startX = e.clientX;
            startY = e.clientY; // Capture initial Y position
            elements.contentPages.style.transition = 'none'; // Disable transition during drag
        }
        
        function handleMouseMove(e) {
            if (!isMouseDown || !isMobile || isInteractingWithControl) return; // Prevent drag if interacting with controls
            
            currentX = e.clientX;
            currentY = e.clientY; // Capture current Y position
            const diffX = currentX - startX;
            const diffY = currentY - startY; // Calculate vertical difference
            
            if (!isDragging) {
                // Only start dragging if horizontal movement is significantly greater than vertical
                if (Math.abs(diffX) > startDragThreshold && Math.abs(diffX) > Math.abs(diffY) * 1.5) { // Factor of 1.5 to prioritize horizontal
                    isDragging = true;
                } else if (Math.abs(diffY) > scrollThreshold && Math.abs(diffY) > Math.abs(diffX) * 1.5) {
                    // If vertical movement is dominant, consider it a scroll, don't start horizontal drag
                    isMouseDown = false; // Reset mouse down state
                    return;
                }
            }
            
            if (isDragging) {
                let targetX = (currentSectionIndex * -window.innerWidth) + diffX;

                // Define boundaries in pixels
                const minPositionPx = -(SECTIONS.length - 1) * window.innerWidth;
                const maxPositionPx = 0;

                // Clamp the targetX to prevent over-dragging and remove bounce
                targetX = Math.max(minPositionPx, Math.min(maxPositionPx, targetX));

                elements.contentPages.style.transform = `translateX(${targetX}px)`;
                e.preventDefault(); // Prevent default scroll behavior
            }
        }
        
        function handleMouseUp() {
            if (!isMouseDown || !isMobile || isInteractingWithControl) return; // Prevent drag if interacting with controls
            
            isMouseDown = false;
            
            if (isDragging) {
                isDragging = false;
                elements.contentPages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)'; // Re-enable transition
                
                const diffX = currentX - startX;
                
                if (diffX > dragThreshold) { // Swipe right
                    navigateSections(-1);
                } else if (diffX < -dragThreshold) { // Swipe left
                    navigateSections(1);
                } else {
                    updateSectionDisplay(); // Snap back to current page
                }
            }
        }
        
        function handleMouseLeave() {
            if (isMouseDown || isDragging) {
                // If mouse leaves while dragging, reset state
                isMouseDown = false;
                isDragging = false;
                elements.contentPages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                updateSectionDisplay(); // Snap back to current page
            }
        }
        
        function handleTouchStart(e) {
            // Check if the touch target is a control element
            const targetTagName = e.target.tagName.toLowerCase();
            if (targetTagName === 'input' || targetTagName === 'select') {
                isInteractingWithControl = true;
                return; // Do not start swipe if interacting with a control
            }
            
            isTouchDown = true;
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY; // Capture initial Y position
            elements.contentPages.style.transition = 'none'; // Disable transition during touch drag
        }
        
        function handleTouchMove(e) {
            if (!isTouchDown || isInteractingWithControl) return; // Prevent drag if interacting with controls
            
            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY; // Capture current Y position
            const diffX = currentX - startX;
            const diffY = currentY - startY; // Calculate vertical difference
            
            if (!isDragging) {
                // Only start dragging if horizontal movement is significantly greater than vertical
                if (Math.abs(diffX) > startDragThreshold && Math.abs(diffX) > Math.abs(diffY) * 1.5) { // Factor of 1.5 to prioritize horizontal
                    isDragging = true;
                } else if (Math.abs(diffY) > scrollThreshold && Math.abs(diffY) > Math.abs(diffX) * 1.5) {
                    // If vertical movement is dominant, consider it a scroll, don't start horizontal drag
                    isTouchDown = false; // Reset touch down state
                    return;
                }
            }
            
            if (isDragging) {
                let targetX = (currentSectionIndex * -window.innerWidth) + diffX;

                // Define boundaries in pixels
                const minPositionPx = -(SECTIONS.length - 1) * window.innerWidth;
                const maxPositionPx = 0;

                // Clamp the targetX to prevent over-dragging and remove bounce
                targetX = Math.max(minPositionPx, Math.min(maxPositionPx, targetX));

                elements.contentPages.style.transform = `translateX(${targetX}px)`;
                e.preventDefault(); // Prevent default scroll behavior
            }
        }
        
        function handleTouchEnd() {
            if (!isTouchDown || isInteractingWithControl) {
                isInteractingWithControl = false; // Reset control interaction flag
                return; // Prevent drag if interacting with controls
            }
            
            isTouchDown = false;
            
            if (isDragging) {
                isDragging = false;
                elements.contentPages.style.transition = 'transform 0.4s cubic-bezier(0.4, 0, 0.2, 1)'; // Re-enable transition
                
                const diffX = currentX - startX;
                
                if (diffX > dragThreshold) { // Swipe right
                    navigateSections(-1);
                } else if (diffX < -dragThreshold) { // Swipe left
                    navigateSections(1);
                } else {
                    updateSectionDisplay(); // Snap back to current page
                }
            }
        }
        
        // --- Keyboard Handling ---
        function handleKeyDown(e) {
            const targetTagName = e.target.tagName.toLowerCase();
            
            // Do not interfere with input/textarea typing
            if (targetTagName === 'input' || targetTagName === 'textarea') {
                return;
            }
            
            // Spacebar for tap tempo
            if (e.code === 'Space' && !isMetronomePlaying) {
                e.preventDefault(); // Prevent page scroll
                tapTempo();
            }
        }
        
        // --- Global Click Handler ---
        function handleWindowClick(event) {
            // Close password modal if clicked outside
            if (event.target === elements.passwordModal) {
                elements.passwordModal.style.display = 'none';
            }
            
            // Close admin modal if clicked outside
            if (event.target === elements.adminModal) {
                elements.adminModal.style.display = 'none';
            }

            // Close confirmation modal if clicked outside (implicitly cancelling)
            if (event.target === elements.confirmationModal) {
                hideConfirmationModal(false);
            }
        }
    </script>
</body>
</html>
